<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ph√≤ng Ch∆°i - Game Room</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #cceeff 0%, #b2ebf2 100%);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        color: #333;
        animation: fadeIn 1s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      header {
        background: #e0f7fa;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-radius: 0 0 10px 10px;
      }

      .back-button {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #b2ebf2;
        color: #006064;
        padding: 5px 10px;
        border-radius: 8px;
        text-decoration: none;
        transition: background 0.3s, transform 0.2s;
      }

      .back-button:hover {
        background: #80deea;
        transform: scale(1.05);
      }

      .container {
        display: flex;
        flex: 1;
        padding: 10px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .chat-box,
      .sidebar {
        background: #ffffff;
        border-radius: 12px;
        padding: 10px;
        flex: 1 1 300px;
        box-sizing: border-box;
        animation: fadeIn 1s ease-in-out;
      }

      .chat-box {
        display: flex;
        flex-direction: column;
        min-width: 320px;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #b2dfdb;
        margin-bottom: 10px;
        padding: 5px;
        border-radius: 8px;
        background: #e0f2f1;
        transition: all 0.3s;
      }

      .message {
        margin-bottom: 5px;
      }

      input[type="text"] {
        padding: 8px;
        width: calc(100% - 90px);
        margin-bottom: 5px;
        border-radius: 8px;
        border: 1px solid #b2ebf2;
        transition: border 0.3s, background 0.3s;
      }

      input[type="text"]:hover {
        border-color: #00acc1;
        background: #f0faff;
      }

      button {
        padding: 8px;
        background: #00bcd4;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        width: 80px;
        margin-left: 5px;
        transition: background 0.3s, transform 0.2s;
      }

      button:hover {
        background: #0097a7;
        transform: scale(1.05);
      }

      .ping-status,
      .game-suggestion {
        font-style: italic;
        font-size: 0.9rem;
        margin-top: 10px;
      }

      .user-count {
        margin-top: 10px;
        font-weight: bold;
        font-size: 0.95rem;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }
        .chat-box,
        .sidebar {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <a href="/" class="back-button">‚Üê Trang ch·ªß</a>
    <header>
      <h1 id="room-title">Ph√≤ng Ch∆°i</h1>
    </header>
    <div class="container">
      <div class="chat-box">
        <div id="messages"></div>
        <div style="display: flex; align-items: center">
          <input
            type="text"
            id="message-input"
            placeholder="Nh·∫≠p tin nh·∫Øn..."
          />
          <button onclick="sendMessage()">G·ª≠i</button>
        </div>
      </div>
      <div class="sidebar">
        <h3>üë• Ng∆∞·ªùi ch∆°i</h3>
        <ul id="user-list"></ul>
        <div class="user-count" id="user-count">T·ªïng s·ªë: 0</div>
        <div class="ping-status" id="ping-status">ƒêang ƒëo ping...</div>
        <div class="game-suggestion" id="game-suggestion"></div>
      </div>
    </div>
    <audio
      id="join-audio"
      src="https://cdn.pixabay.com/download/audio/2022/10/30/audio_97f44f6cc1.mp3"
      preload="auto"
    ></audio>
    <audio
      id="message-audio"
      src="https://cdn.pixabay.com/download/audio/2022/03/14/audio_78bcd76b5b.mp3"
      preload="auto"
    ></audio>
    <audio
      id="leave-audio"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_d90a7cd4b0.mp3"
      preload="auto"
    ></audio>
    <audio
      id="enter-audio"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_d90a7cd4b0.mp3"
      preload="auto"
    ></audio>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const roomId = params.get("room");
      const username = params.get("user");
      const enterAudio = document.getElementById("enter-audio");
      enterAudio.volume = 0.5;

      if (!roomId || !username) {
        alert("Thi·∫øu th√¥ng tin ph√≤ng ho·∫∑c t√™n ng∆∞·ªùi d√πng");
        window.location.href = "/";
      } else {
        fetch(`/api/room/${roomId}`)
          .then((res) => {
            if (!res.ok) throw new Error("Ph√≤ng kh√¥ng t·ªìn t·∫°i");
            return res.json();
          })
          .then(() => {
            enterAudio.play();
            initializeSocket();
          })
          .catch((err) => {
            alert("L·ªói: " + err.message);
            window.location.href = "/";
          });
      }

      function initializeSocket() {
        document.getElementById("room-title").textContent = `Ph√≤ng: ${roomId}`;
        const socket = io();
        const messages = document.getElementById("messages");
        const input = document.getElementById("message-input");
        const joinAudio = document.getElementById("join-audio");
        const messageAudio = document.getElementById("message-audio");
        const leaveAudio = document.getElementById("leave-audio");
        joinAudio.volume = 0.5;
        messageAudio.volume = 0.5;
        leaveAudio.volume = 0.5;

        socket.on("connect", () => {
          socket.emit("join-room", { roomId, username });
        });

        socket.on("user-joined", (data) => {
          const msg = document.createElement("p");
          const time = new Date(data.user.joinedAt).toLocaleTimeString();
          msg.textContent = `${data.user.username} ƒë√£ v√†o ph√≤ng l√∫c ${time} (${data.responseTime}ms)`;
          msg.classList.add("message");
          messages.appendChild(msg);
          messages.scrollTop = messages.scrollHeight;
          joinAudio.play();
        });

        socket.on("room-users", (users) => {
          const userList = document.getElementById("user-list");
          const userCount = document.getElementById("user-count");
          userList.innerHTML = "";
          users.forEach((u) => {
            const li = document.createElement("li");
            li.textContent = u.username;
            userList.appendChild(li);
          });
          userCount.textContent = `T·ªïng s·ªë: ${users.length}`;
        });

        socket.on("chat-message", (data) => {
          const msg = document.createElement("p");
          const time = new Date(data.timestamp).toLocaleTimeString();
          msg.innerHTML = `<strong>${data.username}</strong> (${time}): ${data.message}`;
          msg.classList.add("message");
          messages.appendChild(msg);
          messages.scrollTop = messages.scrollHeight;
          messageAudio.play();
        });

        socket.on("user-left", (data) => {
          const msg = document.createElement("p");
          msg.textContent = `${data.username} ƒë√£ r·ªùi ph√≤ng.`;
          msg.classList.add("message");
          messages.appendChild(msg);
          messages.scrollTop = messages.scrollHeight;
          leaveAudio.play();
        });

        socket.on("ping-update", (data) => {
          const ping = data.averagePing;
          const status = document.getElementById("ping-status");
          const suggestion = document.getElementById("game-suggestion");

          status.textContent =
            `Ping hi·ªán t·∫°i: ${ping}ms - ` +
            (ping < 50
              ? "Tuy·ªát v·ªùi "
              : ping < 100
              ? "T·ªët "
              : ping < 200
              ? "Trung b√¨nh "
              : "K√©m ");

          suggestion.textContent = data.suggestion || "";
        });

        socket.on("error", (data) => {
          alert("L·ªói: " + data.message);
          window.location.href = "/";
        });

        function sendMessage() {
          const text = input.value.trim();
          if (text) {
            socket.emit("chat-message", { message: text });
            input.value = "";
          }
        }

        input.addEventListener("keypress", (e) => {
          if (e.key === "Enter") sendMessage();
        });

        setInterval(() => {
          const pingStart = Date.now();
          socket.emit("ping-test", pingStart);
        }, 5000);

        socket.on("pong-test", (pingStart) => {
          const currentPing = Date.now() - pingStart;
          socket.emit("update-ping", currentPing);
        });
      }
    </script>
  </body>
</html>
